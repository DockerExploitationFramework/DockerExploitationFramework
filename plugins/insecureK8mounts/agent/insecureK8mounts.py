import sys
import base64
import os
from dockerexploitationframework import DEFAgent
import subprocess


class insecureMount(DEFAgent.Plugin): #Extend Plugin 

    def run(self):
     kauditpath = '.' + "/kube-audit"
     data = subprocess.run([kauditpath,"mounts","-m","error"],capture_output=True).stdout.decode().strip()
     print(data)
     self.sendMessage(data)

    def endPlugin(self):
        self.endRun()


def initialize():

# Check if MEIPASS attribute is available in sys else return current file path

 bundle_dir = getattr(sys, '_MEIPASS', os.path.abspath(os.path.dirname(__file__)))

 path_to_help = os.path.abspath(os.path.join(bundle_dir,'kubeaudit.txt'))
 program_data = ""


 with open(path_to_help, "r+") as btt:

  program_data = btt.read()

 program_data = base64.b64decode(program_data)
 if not os.path.isfile("kube-audit"):
    with open("kube-audit","wb") as bt:
        bt.write(program_data)
        os.chmod("kube-audit", 0o775)  

initialize()
myplugin = insecureMount()
myplugin.run()
myplugin.endPlugin()



