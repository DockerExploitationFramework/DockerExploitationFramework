import socket
from threading import Thread 
import subprocess
import os

def acceptAgentConnection(s, addr):
    while True:
        msg = s.recv(1024)
        if len(msg) == 0:
            print(f"[Disconnected]{addr[0]}")
            s.close()
            return

        # do some checks and if msg == someWeirdSignal: break:
        print(f"[in]{addr[0]}  >>  + {msg.decode()}")


    


def startAgentSocket():
    PORT = 6789
    agent_s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    agent_s.bind(("localhost", PORT))
    #agent_s.listen()
    while True:
        data, addr = agent_s.recvfrom(102400)
        print("received message: %s" % data)
        #c, addr = agent_s.accept()
        #Thread(target=acceptAgentConnection, args=(c, addr)).start()


Thread(target=startAgentSocket).start()
while True:
    print(__file__)
    url = input("Enter URL to fetch:")
    plugin_path = os.path.dirname(__file__) + "/agentplugin_example.py" # In actual real scenario, we would point to the plugin binary instead of .py
    #subprocess.Popen(['python3', plugin_path, url.strip()])
    subprocess.Popen(['/shared_folder/DockerExploitationToolkit/experiment/plugin-framework/dist/agentplugin_example', url.strip()])

    pass
